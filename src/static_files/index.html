<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VK ID Auth</title>
</head>

<body>
    <div id="VkIdSdkOneTap">
        <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
        <script type="text/javascript">

            if ('VKIDSDK' in window) {
                const VKID = window.VKIDSDK;
                const state = generateRandomString(16);
                const code_challenge = sha256(generateRandomString(64));

                // Инициализация конфигурации VK ID
                VKID.Config.init({
                    app: 53265566,
                    redirectUrl: "http://localhost/vk-callback", // возможно придется поменять на basedomen, который будет храниться как переменная окружения
                    responseMode: VKID.ConfigResponseMode.Redirect,
                    source: VKID.ConfigSource.LOWCODE,
                    state: state,
                    code_challenge: code_challenge,
                    scope: 'phone',
                });

                // Инициализация виджета
                const oneTap = new VKID.OneTap();

                // Рендер виджета
                oneTap.render({
                    container: document.currentScript.parentElement,
                    showAlternativeLogin: true
                });


                // Как получить и обработать данные
                // После вызова метода oneTap.render() в контейнере появится кнопка One Tap. Когда пользователь авторизуется в сервисе, 
                // SDK передает код подтверждения code, строку состояния state и идентификатор устройства device_id. 
                // Есть два способа получить эти данные:
                // 1) через URL перенаправления — используется по умолчанию (ВЫБРАН В ПРОЕКТЕ)
                // 2) через callback.
                // Получение code, state и device_id через URL перенаправления не требует каких-либо действий. Данные будут переданы в query-параметрах на адрес, 
                // который указан в поле redirectUrl настроек SDK. (ЗА ЭТО ОТВЧАЕТ ENDPOINT FASTAPI)
                // Однако если вы получаете параметры через callback, настройте обработчик успешной авторизации (НЕ ИНТЕРЕСУЕТ)

                // Обработка ошибок
                oneTap.on(VKID.WidgetEvents.ERROR, function (error) {   //Нужно получать код с обменом на backend
                    console.error("VK ID Error:", error);
                    window.open(
                        '/auth-error'
                    );
                });
            } else {
                console.log("VK SDK is not downloaded")
            }
            
            function generateRandomString(n, charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789') {
                const cryptoObj = window.crypto || window.msCrypto;
                if (cryptoObj && cryptoObj.getRandomValues) {
                    const values = new Uint32Array(n);
                    cryptoObj.getRandomValues(values);
                    return Array.from(values)
                        .map(x => charset[x % charset.length])
                        .join('');
                } else {
                    let result = '';
                    for (let i = 0; i < n; i++) {
                        result += charset.charAt(Math.floor(Math.random() * charset.length));
                    }
                    return result;
                }
            }

            async function sha256(input) {
                const bytes = new TextEncoder().encode(input);
                const hash = await crypto.subtle.digest('SHA-256', bytes);
                return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
            }

        </script>
    </div>
</body>

</html>
